name: Sync upstream x402 examples/fullstack/next

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  schedule: [{ cron: "0 * * * *" }] # hourly
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Skip PR creation; run sanitize + verify only"
        required: false
        default: "false"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions: { contents: write, pull-requests: write }
    env:
      UPSTREAM_REPO: coinbase/x402
      UPSTREAM_PATH: examples/typescript/fullstack/next
      DRY_RUN: ${{ inputs.dry_run }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure required tools are available
        run: |
          set -euo pipefail
          if ! command -v rsync >/dev/null 2>&1; then
            (apt-get update && apt-get install -y rsync) || (sudo apt-get update && sudo apt-get install -y rsync)
          fi

      - name: Sparse clone upstream
        run: |
          git clone --depth=1 --filter=blob:none --sparse https://github.com/${UPSTREAM_REPO}.git upstream
          cd upstream
          git sparse-checkout set "${UPSTREAM_PATH}"
          echo "UPSTREAM_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Resolve latest @x402/next version from npm
        run: |
          set -euo pipefail
          VERSION=$(npm view @x402/next version 2>/dev/null || echo "0.0.0")
          echo "X402_NEXT_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Store old version for comparison
        run: |
          OLD_NEXT=$(node -e "const fs=require('fs');const j=JSON.parse(fs.readFileSync('package.json','utf8'));const c=j.config||{};console.log(c.x402NextVersion||'0.0.0')")
          echo "OLD_X402_NEXT_VERSION=${OLD_NEXT}" >> $GITHUB_ENV

      - name: Record resolved version in root package.json
        run: |
          node -e "const fs=require('fs');const p='package.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));(j.config??={});j.config.x402NextVersion=process.env.X402_NEXT_VERSION;fs.writeFileSync(p,JSON.stringify(j,null,2));"

      - name: Stage upstream into vendor folder
        run: |
          rm -rf vendor/upstream && mkdir -p vendor/upstream
          rsync -a --delete upstream/${UPSTREAM_PATH}/ vendor/upstream/

      - name: Sanitize & map into template (best-effort)
        run: |
          if [ -f scripts/sanitize.sh ]; then
            chmod +x scripts/sanitize.sh
            scripts/sanitize.sh "${UPSTREAM_PATH}" "${UPSTREAM_SHA}"
          else
            echo "No sanitize script found; skipping."
          fi

      - name: Verify env overrides preserved
        run: |
          set -euo pipefail
          FILE="template/.env.example"
          if [[ ! -f "$FILE" ]]; then
            echo "Missing $FILE after sanitize step" >&2
            exit 1
          fi
          grep -Eq '^NEXT_PUBLIC_FACILITATOR_URL=https://facilitator.payai.network$' "$FILE" || { echo "NEXT_PUBLIC_FACILITATOR_URL incorrect in $FILE" >&2; exit 1; }
          grep -Eq '^NETWORK=solana-devnet$' "$FILE" || { echo "NETWORK incorrect in $FILE" >&2; exit 1; }
          echo "Env overrides verified in $FILE."

      - name: Inject x402 package versions into template/package.json
        run: |
          node <<'EOF'
          const fs = require('fs');
          const p = 'template/package.json';
          if (!fs.existsSync(p)) process.exit(0);
          const j = JSON.parse(fs.readFileSync(p, 'utf8'));
          const v = process.env.X402_NEXT_VERSION;
          if (!v || v === '0.0.0') process.exit(0);

          j.dependencies = j.dependencies || {};
          // Ensure all required x402 packages are present with correct versions
          const x402Packages = ['@x402/next', '@x402/core', '@x402/evm', '@x402/svm', '@x402/paywall', '@x402/extensions'];
          for (const pkg of x402Packages) {
            j.dependencies[pkg] = '^' + v;
          }

          // Remove legacy x402-next if present
          delete j.dependencies['x402-next'];

          fs.writeFileSync(p, JSON.stringify(j, null, 2));
          console.log(`Set x402 packages to ^${v}`);
          EOF

      - name: Determine if there are changes
        run: |
          # include untracked files in change detection
          if git diff --quiet && git ls-files --others --exclude-standard --error-unmatch . >/dev/null 2>&1; then
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Bump starter package version
        if: ${{ env.HAS_CHANGES == 'true' && env.DRY_RUN != 'true' }}
        run: |
          node <<'EOF'
          const fs = require('fs');
          const p = 'package.json';
          const j = JSON.parse(fs.readFileSync(p, 'utf-8'));
          const v = j.version || '0.0.0';
          const parts = v.split('.').map(n => parseInt(n, 10));
          while (parts.length < 3) parts.push(0);

          const parseVersion = (v) => {
            if (!v || v === '0.0.0') return { major: 0, minor: 0, patch: 0 };
            const parts = v.split('.').map(n => parseInt(n, 10));
            return {
              major: isNaN(parts[0]) ? 0 : parts[0],
              minor: isNaN(parts[1]) ? 0 : parts[1],
              patch: isNaN(parts[2]) ? 0 : parts[2],
            };
          };

          const compareVersions = (oldV, newV) => {
            if (oldV === '0.0.0') return 'none'; // New dependency, don't count as change
            const old = parseVersion(oldV);
            const new_ = parseVersion(newV);

            if (old.major < new_.major) return 'major';
            if (old.major === new_.major && old.minor < new_.minor) return 'minor';
            if (old.major === new_.major && old.minor === new_.minor && old.patch < new_.patch) return 'patch';
            return 'none';
          };

          const oldNext = process.env.OLD_X402_NEXT_VERSION || '0.0.0';
          const newNext = process.env.X402_NEXT_VERSION || '0.0.0';
          const change = compareVersions(oldNext, newNext);

          if (change === 'major' || change === 'minor') {
            parts[1] = (parts[1] || 0) + 1;
            parts[2] = 0;
            console.log(`Detected ${change} version change in @x402/next: ${oldNext} → ${newNext}`);
            console.log('Bumping minor version');
          } else {
            parts[2] = (parts[2] || 0) + 1;
            console.log('Only patch changes detected, bumping patch version');
          }

          j.version = parts.join('.');
          fs.writeFileSync(p, JSON.stringify(j, null, 2));
          console.log(`Bumped version to ${j.version}`);
          EOF
        env:
          OLD_X402_NEXT_VERSION: ${{ env.OLD_X402_NEXT_VERSION }}
          X402_NEXT_VERSION: ${{ env.X402_NEXT_VERSION }}

      - name: Open PR with changes
        if: ${{ env.HAS_CHANGES == 'true' && env.DRY_RUN != 'true' }}
        uses: peter-evans/create-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          commit-message: "chore(next): sync from ${UPSTREAM_REPO}@${{ env.UPSTREAM_SHA }}"
          branch: chore/sync-upstream
          title: "Sync upstream (fullstack/next) — ${{ env.UPSTREAM_SHA }}"
          body: |
            Auto-synced from https://github.com/${{ env.UPSTREAM_REPO }}
            Path: ${{ env.UPSTREAM_PATH }}
            SHA:  ${{ env.UPSTREAM_SHA }}

      - name: Summary (dry-run)
        if: ${{ env.DRY_RUN == 'true' }}
        run: |
          echo "Dry run completed. Env overrides verified and no PR was opened." | tee -a $GITHUB_STEP_SUMMARY
